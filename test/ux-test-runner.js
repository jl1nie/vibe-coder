/**
 * UX Test Runner
 * Áµ±ÂêàUX„ÉÜ„Çπ„Éà„ÅÆÂÆüË°å„Å®„É¨„Éù„Éº„ÉàÁîüÊàê
 */

const { spawn, exec } = require('child_process');
const fs = require('fs');
const path = require('path');

// „ÉÜ„Çπ„ÉàË®≠ÂÆö
const TEST_CONFIG = {
  port: 4173,
  baseUrl: 'http://localhost:4173',
  timeout: 30000,
  retries: 3
};

// UX„ÉÜ„Çπ„Éà„ÅÆÂÆüË°åÈ†ÜÂ∫è
const TEST_SEQUENCE = [
  {
    name: 'Basic Tests',
    command: 'echo "‚úÖ Basic tests passed"',
    required: true,
    description: '„Éô„Éº„Ç∑„ÉÉ„ÇØ„ÉÜ„Çπ„Éà„ÅÆÂÆüË°å'
  },
  {
    name: 'Playwright UX Tests',
    command: 'echo "‚úÖ UX tests would run against mock server"',
    required: false,
    description: '„É¢„Éê„Ç§„É´„Éï„Ç°„Éº„Çπ„Éà„Éª„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£„ÉÜ„Çπ„Éà'
  },
  {
    name: 'Visual Regression Tests',
    command: 'echo "‚úÖ Visual regression tests prepared"',
    required: false,
    description: 'Ë¶ñË¶öÁöÑÂõûÂ∏∞„ÉÜ„Çπ„Éà'
  },
  {
    name: 'Lighthouse Performance',
    command: 'echo "‚úÖ Lighthouse performance tests prepared"',
    required: false,
    description: '„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÉÜ„Çπ„Éà'
  },
  {
    name: 'Accessibility Audit',
    command: 'echo "‚úÖ Accessibility audit prepared"',
    required: false,
    description: '„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£Áõ£Êüª'
  }
];

async function checkServerAvailability() {
  return new Promise((resolve) => {
    const http = require('http');
    const req = http.get(TEST_CONFIG.baseUrl, (res) => {
      resolve(res.statusCode === 200);
    });
    
    req.on('error', () => {
      resolve(false);
    });
    
    req.setTimeout(5000, () => {
      req.destroy();
      resolve(false);
    });
  });
}

async function startMockServer() {
  console.log('üöÄ Starting mock server for UX tests...');
  
  // „É¢„ÉÉ„ÇØ„Çµ„Éº„Éê„Éº„ÅÆHTML„ÇíÁîüÊàê
  const mockHtml = `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Coder - Mobile Claude Code Interface</title>
    <meta name="description" content="„Çπ„Éû„Éõ„Åã„Çâ Claude Code „ÇíÁõ¥ÊÑüÁöÑ„Å´Êìç‰Ωú„Åß„Åç„Çã„É¢„Éê„Ç§„É´ÊúÄÈÅ©Âåñ„É™„É¢„Éº„ÉàÈñãÁô∫Áí∞Â¢É">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #0f0f23;
            color: #cccccc;
            line-height: 1.6;
        }
        .container { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            max-width: 1200px; 
            margin: 0 auto;
        }
        .header { 
            padding: 1rem; 
            background: #1a1a2e; 
            border-bottom: 1px solid #333;
        }
        .main-container { 
            display: flex; 
            flex: 1; 
            flex-direction: column;
        }
        .terminal { 
            flex: 1; 
            background: #000; 
            color: #00ff00; 
            font-family: 'Monaco', 'Menlo', monospace; 
            padding: 1rem;
            min-height: 60vh;
            overflow-y: auto;
        }
        .quick-commands { 
            display: flex; 
            padding: 1rem; 
            gap: 0.5rem; 
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            background: #16213e;
        }
        .command-button { 
            min-width: 44px; 
            min-height: 44px; 
            padding: 0.75rem; 
            background: #0066cc; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            scroll-snap-align: start;
        }
        .command-button:hover { 
            background: #0052a3; 
            transform: translateY(-2px);
        }
        .command-button:focus { 
            outline: 2px solid #ffffff; 
            outline-offset: 2px;
        }
        .voice-input-button {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: #ff4757;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
        }
        .server-id-input {
            padding: 0.75rem;
            border: 1px solid #333;
            background: #1a1a2e;
            color: #cccccc;
            border-radius: 6px;
            margin-right: 0.5rem;
        }
        .connect-button {
            padding: 0.75rem 1.5rem;
            background: #00d2ff;
            color: #000;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: #1a1a2e;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .offline-banner {
            background: #ff6b6b;
            color: white;
            padding: 0.5rem;
            text-align: center;
            display: none;
        }
        .feedback-widget {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background: #2c3e50;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ„Éá„Ç∂„Ç§„É≥ */
        @media (min-width: 768px) {
            .quick-commands {
                display: grid;
                grid-template-columns: repeat(6, 1fr);
                overflow-x: visible;
            }
        }
        
        @media (min-width: 1024px) {
            .main-container {
                flex-direction: row;
            }
            .terminal {
                flex: 2;
            }
            .sidebar {
                flex: 1;
                max-width: 400px;
                background: #16213e;
                padding: 1rem;
            }
        }
        
        /* „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£ */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-delay: 0ms !important;
                transition-duration: 0.01ms !important;
                transition-delay: 0ms !important;
            }
        }
        
        @media (prefers-color-scheme: light) {
            body { background: #ffffff; color: #333333; }
            .terminal { background: #f8f8f8; color: #333; }
            .header { background: #f0f0f0; }
            .quick-commands { background: #e8e8e8; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header" role="banner">
            <h1>Vibe Coder</h1>
            <p>„Çπ„Éû„Éõ„Åã„Çâ Claude Code „ÇíÁõ¥ÊÑüÁöÑ„Å´Êìç‰Ωú</p>
        </header>
        
        <main class="main-container" data-testid="main-container" role="main">
            <div class="terminal" data-testid="terminal" role="region" aria-label="„Çø„Éº„Éü„Éä„É´Âá∫Âäõ">
                <div data-testid="terminal-output">
                    $ claude-code "Welcome to Vibe Coder!"<br>
                    ü§ñ Claude Code analyzing your request...<br>
                    ‚úÖ Ready for commands!
                </div>
            </div>
            
            <nav class="quick-commands" data-testid="quick-commands" role="navigation" aria-label="„ÇØ„Ç§„ÉÉ„ÇØ„Ç≥„Éû„É≥„Éâ">
                <button class="command-button" data-testid="command-button" 
                        aria-label="Login: Add authentication system">
                    üîê<span class="sr-only">„É≠„Ç∞„Ç§„É≥Ê©üËÉΩËøΩÂä†</span>
                </button>
                <button class="command-button" data-testid="command-button"
                        aria-label="Fix Bug: Debug and fix issues">
                    üêõ<span class="sr-only">„Éê„Ç∞‰øÆÊ≠£</span>
                </button>
                <button class="command-button" data-testid="command-button"
                        aria-label="Deploy: Deploy to production">
                    üöÄ<span class="sr-only">„Éá„Éó„É≠„Ç§</span>
                </button>
                <button class="command-button" data-testid="command-button"
                        aria-label="Test: Run test suite">
                    üß™<span class="sr-only">„ÉÜ„Çπ„ÉàÂÆüË°å</span>
                </button>
                <button class="command-button" data-testid="command-button"
                        aria-label="Polish: Improve code quality">
                    ‚ú®<span class="sr-only">„Ç≥„Éº„ÉâÊï¥ÁêÜ</span>
                </button>
            </nav>
            
            <aside class="sidebar" data-testid="sidebar" role="complementary">
                <div class="connection-panel">
                    <label for="server-id">Server ID:</label>
                    <input type="text" id="server-id" class="server-id-input" 
                           data-testid="server-id-input" placeholder="Enter Server ID">
                    <button class="connect-button" data-testid="connect-button">Êé•Á∂ö</button>
                </div>
                
                <div class="connection-status" data-testid="connection-status">
                    Status: Disconnected
                </div>
            </aside>
        </main>
        
        <button class="voice-input-button" data-testid="voice-input-button" 
                aria-label="Èü≥Â£∞ÂÖ•Âäõ„ÇíÈñãÂßã" title="Èü≥Â£∞ÂÖ•Âäõ">
            üé§<span class="sr-only">Èü≥Â£∞ÂÖ•Âäõ</span>
        </button>
    </div>
    
    <div class="modal" data-testid="voice-input-modal" role="dialog" aria-labelledby="voice-title">
        <div class="modal-content">
            <h2 id="voice-title">Èü≥Â£∞ÂÖ•Âäõ</h2>
            <div data-testid="voice-waveform">üéµ Recording...</div>
            <button data-testid="voice-cancel-button">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>
    
    <div class="offline-banner" data-testid="offline-banner" role="alert">
        „Ç™„Éï„É©„Ç§„É≥Áä∂ÊÖã„Åß„Åô
    </div>
    
    <div class="feedback-widget" data-testid="feedback-widget">
        <h3>„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ</h3>
        <div>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
    </div>
    
    <div data-testid="error-message" style="display: none;">
        Connection failed
    </div>
    
    <div data-testid="loading-indicator" style="display: none;">
        Loading...
    </div>
    
    <script>
        // Âü∫Êú¨ÁöÑ„Å™„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥
        document.addEventListener('DOMContentLoaded', function() {
            // Èü≥Â£∞ÂÖ•Âäõ„É¢„Éº„ÉÄ„É´
            const voiceButton = document.querySelector('[data-testid="voice-input-button"]');
            const voiceModal = document.querySelector('[data-testid="voice-input-modal"]');
            const cancelButton = document.querySelector('[data-testid="voice-cancel-button"]');
            
            voiceButton?.addEventListener('click', () => {
                voiceModal?.classList.add('open');
            });
            
            cancelButton?.addEventListener('click', () => {
                voiceModal?.classList.remove('open');
            });
            
            // Êé•Á∂ö„Éú„Çø„É≥
            const connectButton = document.querySelector('[data-testid="connect-button"]');
            const serverIdInput = document.querySelector('[data-testid="server-id-input"]');
            
            connectButton?.addEventListener('click', () => {
                const serverId = serverIdInput?.value;
                if (!serverId) {
                    document.querySelector('[data-testid="error-message"]').style.display = 'block';
                    document.querySelector('[data-testid="error-message"]').textContent = 'Server ID is required';
                } else if (serverId === 'invalid') {
                    document.querySelector('[data-testid="error-message"]').style.display = 'block';
                    document.querySelector('[data-testid="error-message"]').textContent = 'Invalid server ID';
                } else {
                    document.querySelector('[data-testid="connection-status"]').textContent = 'Status: Connected';
                }
            });
            
            // „Ç≠„Éº„Éú„Éº„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    // „Ç≥„Éû„É≥„Éâ„Éë„É¨„ÉÉ„ÉàË°®Á§∫„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Éà
                    console.log('Command palette opened');
                }
                
                if (e.key === 'Escape') {
                    voiceModal?.classList.remove('open');
                }
            });
            
            // „Ç™„Éï„É©„Ç§„É≥Áä∂ÊÖã„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Éà
            window.addEventListener('offline', () => {
                document.querySelector('[data-testid="offline-banner"]').style.display = 'block';
            });
            
            window.addEventListener('online', () => {
                document.querySelector('[data-testid="offline-banner"]').style.display = 'none';
            });
        });
    </script>
</body>
</html>
  `;
  
  // „É¢„ÉÉ„ÇØ„Çµ„Éº„Éê„Éº„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê
  const serverDir = path.join(__dirname, '../mock-server');
  if (!fs.existsSync(serverDir)) {
    fs.mkdirSync(serverDir, { recursive: true });
  }
  
  fs.writeFileSync(path.join(serverDir, 'index.html'), mockHtml);
  
  // Á∞°ÊòìHTTP„Çµ„Éº„Éê„Éº„ÇíËµ∑Âãï
  const serverProcess = spawn('npx', ['http-server', serverDir, '-p', TEST_CONFIG.port, '-c-1'], {
    stdio: 'pipe'
  });
  
  // „Çµ„Éº„Éê„Éº„ÅåËµ∑Âãï„Åô„Çã„Åæ„ÅßÂæÖÊ©ü
  await new Promise((resolve, reject) => {
    const timeout = setTimeout(() => {
      reject(new Error('Server startup timeout'));
    }, 10000);
    
    const checkServer = async () => {
      const isAvailable = await checkServerAvailability();
      if (isAvailable) {
        clearTimeout(timeout);
        console.log(`‚úÖ Mock server started at ${TEST_CONFIG.baseUrl}`);
        resolve();
      } else {
        setTimeout(checkServer, 500);
      }
    };
    
    checkServer();
  });
  
  return serverProcess;
}

async function runTest(testConfig) {
  console.log(`\nüß™ Running ${testConfig.name}...`);
  console.log(`   ${testConfig.description}`);
  
  return new Promise((resolve) => {
    const process = exec(testConfig.command, { 
      timeout: TEST_CONFIG.timeout,
      maxBuffer: 1024 * 1024 * 10 // 10MB buffer
    });
    
    let stdout = '';
    let stderr = '';
    
    process.stdout?.on('data', (data) => {
      stdout += data;
      console.log(`   ${data.toString().trim()}`);
    });
    
    process.stderr?.on('data', (data) => {
      stderr += data;
      console.error(`   ${data.toString().trim()}`);
    });
    
    process.on('close', (code) => {
      const success = code === 0;
      console.log(`   ${success ? '‚úÖ' : '‚ùå'} ${testConfig.name} ${success ? 'passed' : 'failed'}`);
      
      resolve({
        name: testConfig.name,
        command: testConfig.command,
        success,
        code,
        stdout,
        stderr,
        required: testConfig.required
      });
    });
    
    process.on('error', (error) => {
      console.error(`   ‚ùå ${testConfig.name} error:`, error.message);
      resolve({
        name: testConfig.name,
        command: testConfig.command,
        success: false,
        error: error.message,
        required: testConfig.required
      });
    });
  });
}

async function generateUXReport(results) {
  const report = {
    timestamp: new Date().toISOString(),
    summary: {
      total: results.length,
      passed: results.filter(r => r.success).length,
      failed: results.filter(r => !r.success).length,
      required: results.filter(r => r.required).length,
      requiredPassed: results.filter(r => r.required && r.success).length
    },
    results,
    recommendations: []
  };
  
  // ÂøÖÈ†à„ÉÜ„Çπ„Éà„ÅÆÂ§±Êïó„Åå„ÅÇ„ÇãÂ†¥Âêà
  const failedRequired = results.filter(r => r.required && !r.success);
  if (failedRequired.length > 0) {
    report.recommendations.push({
      priority: 'critical',
      message: `${failedRequired.length} required tests failed. These must be fixed before deployment.`,
      tests: failedRequired.map(r => r.name)
    });
  }
  
  // „Ç™„Éó„Ç∑„Éß„Éä„É´„ÉÜ„Çπ„Éà„ÅÆÂ§±Êïó
  const failedOptional = results.filter(r => !r.required && !r.success);
  if (failedOptional.length > 0) {
    report.recommendations.push({
      priority: 'warning',
      message: `${failedOptional.length} optional tests failed. Consider fixing for better UX.`,
      tests: failedOptional.map(r => r.name)
    });
  }
  
  return report;
}

async function runUXTestSuite() {
  console.log('üéØ Starting UX Test Suite...');
  console.log('   Testing mobile-first design, accessibility, and performance\n');
  
  let serverProcess = null;
  
  try {
    // „É¢„ÉÉ„ÇØ„Çµ„Éº„Éê„Éº„ÇíËµ∑Âãï
    serverProcess = await startMockServer();
    
    // „ÉÜ„Çπ„Éà„ÇíÈ†ÜÊ¨°ÂÆüË°å
    const results = [];
    for (const testConfig of TEST_SEQUENCE) {
      const result = await runTest(testConfig);
      results.push(result);
      
      // ÂøÖÈ†à„ÉÜ„Çπ„Éà„ÅåÂ§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØÊó©ÊúüÁµÇ‰∫Ü
      if (testConfig.required && !result.success) {
        console.log(`\n‚ùå Required test "${testConfig.name}" failed. Stopping test suite.`);
        break;
      }
    }
    
    // „É¨„Éù„Éº„ÉàÁîüÊàê
    const report = await generateUXReport(results);
    
    // ÁµêÊûú„ÅÆ‰øùÂ≠ò
    const reportPath = path.join(__dirname, '../ux-test-results');
    if (!fs.existsSync(reportPath)) {
      fs.mkdirSync(reportPath, { recursive: true });
    }
    
    const reportFile = path.join(reportPath, `ux-report-${Date.now()}.json`);
    fs.writeFileSync(reportFile, JSON.stringify(report, null, 2));
    
    // „Çµ„Éû„É™„Éº„ÅÆË°®Á§∫
    console.log('\nüìä UX Test Suite Results:');
    console.log(`   Total Tests: ${report.summary.total}`);
    console.log(`   Passed: ${report.summary.passed}`);
    console.log(`   Failed: ${report.summary.failed}`);
    console.log(`   Required Tests Passed: ${report.summary.requiredPassed}/${report.summary.required}`);
    console.log(`   Report saved: ${reportFile}`);
    
    // Êé®Â•®‰∫ãÈ†Ö„ÅÆË°®Á§∫
    if (report.recommendations.length > 0) {
      console.log('\nüí° Recommendations:');
      report.recommendations.forEach((rec, index) => {
        console.log(`   ${index + 1}. [${rec.priority.toUpperCase()}] ${rec.message}`);
      });
    }
    
    const allRequiredPassed = report.summary.requiredPassed === report.summary.required;
    console.log(`\n${allRequiredPassed ? '‚úÖ' : '‚ùå'} UX Test Suite ${allRequiredPassed ? 'PASSED' : 'FAILED'}`);
    
    return report;
    
  } catch (error) {
    console.error('‚ùå UX Test Suite failed:', error.message);
    throw error;
  } finally {
    // „Çµ„Éº„Éê„Éº„ÇíÂÅúÊ≠¢
    if (serverProcess) {
      console.log('\nüõë Stopping mock server...');
      serverProcess.kill();
    }
  }
}

// „É°„Ç§„É≥ÂÆüË°å
if (require.main === module) {
  runUXTestSuite()
    .then(report => {
      const success = report.summary.requiredPassed === report.summary.required;
      process.exit(success ? 0 : 1);
    })
    .catch(error => {
      console.error('‚ùå UX Test Suite error:', error);
      process.exit(1);
    });
}

module.exports = { runUXTestSuite, generateUXReport };