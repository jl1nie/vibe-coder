name: ğŸš€ Staging Deployment

on:
  push:
    branches: [ develop, staging ]
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  test:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run tests
        run: |
          npm run test
          npm run test:integration

      - name: ğŸ“Š Generate test report
        run: |
          echo "# ğŸ§ª Test Results" > test-report.md
          echo "## Unit Tests" >> test-report.md
          echo "âœ… All unit tests passed" >> test-report.md
          echo "## Integration Tests" >> test-report.md
          echo "âœ… All integration tests passed" >> test-report.md

      - name: ğŸ“‹ Comment test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const testReport = fs.readFileSync('test-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: testReport
            });

  deploy-staging:
    name: ğŸ—ï¸ Deploy to Staging
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/develop'
    environment: 
      name: staging
      url: https://staging.vibe-coder.space
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build PWA
        run: |
          npm run build
        env:
          VITE_APP_ENV: staging
          VITE_API_BASE_URL: https://staging-api.vibe-coder.space
          VITE_SIGNALING_URL: https://staging.vibe-coder.space
          VITE_SENTRY_DSN: ${{ secrets.STAGING_SENTRY_DSN }}

      - name: ğŸš€ Deploy PWA to Vercel
        uses: vercel/action@v1
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--env NODE_ENV=staging'
          working-directory: apps/web
        
      - name: ğŸ¯ Deploy Signaling Server
        working-directory: packages/signaling
        run: |
          npx vercel --token ${{ secrets.VERCEL_TOKEN }} \
                    --scope ${{ secrets.VERCEL_ORG_ID }} \
                    --env NODE_ENV=staging \
                    --env KV_URL=${{ secrets.STAGING_KV_URL }} \
                    --env KV_REST_API_URL=${{ secrets.STAGING_KV_REST_API_URL }} \
                    --env KV_REST_API_TOKEN=${{ secrets.STAGING_KV_REST_API_TOKEN }} \
                    --build-env NODE_ENV=staging

      - name: ğŸ”— Get deployment URLs
        id: deployment
        run: |
          echo "pwa_url=https://staging.vibe-coder.space" >> $GITHUB_OUTPUT
          echo "signaling_url=https://staging.vibe-coder.space" >> $GITHUB_OUTPUT

      - name: ğŸš¦ Health check
        run: |
          # Wait for deployment to be ready
          sleep 30
          
          # Check PWA health
          curl -f ${{ steps.deployment.outputs.pwa_url }}/health || exit 1
          
          # Check Signaling Server health
          curl -f ${{ steps.deployment.outputs.signaling_url }}/api/health || exit 1

      - name: ğŸ“± Run E2E tests on staging
        run: |
          npx playwright install chromium
          npm run test:e2e -- --base-url=${{ steps.deployment.outputs.pwa_url }}
        env:
          E2E_BASE_URL: ${{ steps.deployment.outputs.pwa_url }}

      - name: ğŸ“Š Performance audit
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: ${{ steps.deployment.outputs.pwa_url }}
          configPath: ./.lighthouserc.json
          uploadArtifacts: true

  notify-deployment:
    name: ğŸ“¢ Notify Team
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: always()
    
    steps:
      - name: ğŸ“‹ Create deployment summary
        run: |
          echo "# ğŸš€ Staging Deployment Summary" > deployment-summary.md
          echo "" >> deployment-summary.md
          echo "## ğŸ¯ Environment: Staging" >> deployment-summary.md
          echo "- **PWA URL**: https://staging.vibe-coder.space" >> deployment-summary.md
          echo "- **Signaling API**: https://staging.vibe-coder.space/api" >> deployment-summary.md
          echo "- **Commit**: ${{ github.sha }}" >> deployment-summary.md
          echo "- **Branch**: ${{ github.ref_name }}" >> deployment-summary.md
          echo "" >> deployment-summary.md
          echo "## ğŸ§ª Test Results" >> deployment-summary.md
          if [ "${{ needs.deploy-staging.result }}" == "success" ]; then
            echo "âœ… All tests passed and deployment successful" >> deployment-summary.md
          else
            echo "âŒ Deployment failed or tests failed" >> deployment-summary.md
          fi
          echo "" >> deployment-summary.md
          echo "## ğŸ”— Quick Links" >> deployment-summary.md
          echo "- [Open Staging App](https://staging.vibe-coder.space)" >> deployment-summary.md
          echo "- [View API Status](https://staging.vibe-coder.space/api/health)" >> deployment-summary.md
          echo "- [Performance Report](https://staging.vibe-coder.space/lighthouse)" >> deployment-summary.md
          echo "" >> deployment-summary.md
          echo "## ğŸ“ Manual Testing Checklist" >> deployment-summary.md
          echo "- [ ] PWAå®‰è£…å’Œç¦»çº¿åŠŸèƒ½" >> deployment-summary.md
          echo "- [ ] WebRTCæ¥ç¶šãƒ†ã‚¹ãƒˆ" >> deployment-summary.md
          echo "- [ ] éŸ³å£°å…¥åŠ›æ©Ÿèƒ½" >> deployment-summary.md
          echo "- [ ] ã‚¯ã‚¤ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ" >> deployment-summary.md
          echo "- [ ] ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆæ©Ÿèƒ½" >> deployment-summary.md
          echo "- [ ] ãƒ¢ãƒã‚¤ãƒ«æ“ä½œæ€§" >> deployment-summary.md
          echo "- [ ] ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£" >> deployment-summary.md

      - name: ğŸ“¢ Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#vibe-coder-dev'
          text: |
            ğŸš€ Staging deployment completed
            
            Environment: Staging
            Status: ${{ needs.deploy-staging.result }}
            URL: https://staging.vibe-coder.space
            
            Ready for UX testing and feedback collection!
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  feedback-collection:
    name: ğŸ“ Setup Feedback Collection
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: success()
    
    steps:
      - name: ğŸ“ Create feedback issue
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ” UX Feedback - Staging Deployment ${new Date().toISOString().split('T')[0]}`,
              body: `
            # ğŸ¯ UX ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†

            ## ğŸ“± ãƒ†ã‚¹ãƒˆç’°å¢ƒ
            - **URL**: https://staging.vibe-coder.space
            - **Commit**: ${context.sha}
            - **Deployed**: ${new Date().toISOString()}

            ## ğŸ§ª ãƒ†ã‚¹ãƒˆé …ç›®

            ### PWAåŸºæœ¬æ©Ÿèƒ½
            - [ ] ãƒ›ãƒ¼ãƒ ç”»é¢ã¸ã®è¿½åŠ 
            - [ ] ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œ
            - [ ] ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥
            - [ ] ã‚¢ãƒ—ãƒªã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º

            ### ã‚³ã‚¢æ©Ÿèƒ½
            - [ ] ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šãƒ•ãƒ­ãƒ¼
            - [ ] ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
            - [ ] éŸ³å£°å…¥åŠ›
            - [ ] ã‚¯ã‚¤ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰
            - [ ] ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç®¡ç†

            ### ãƒ¢ãƒã‚¤ãƒ«UX
            - [ ] ã‚¿ãƒƒãƒæ“ä½œæ€§
            - [ ] ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼
            - [ ] ç”»é¢å›è»¢å¯¾å¿œ
            - [ ] ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºæ™‚ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

            ### ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£
            - [ ] ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å¯¾å¿œ
            - [ ] ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
            - [ ] é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰
            - [ ] éŸ³å£°ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹

            ## ğŸ“ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ•ã‚©ãƒ¼ãƒ 

            ### è‰¯ã„ç‚¹
            <!-- æ°—ã«å…¥ã£ãŸæ©Ÿèƒ½ã‚„ä½¿ã„ã‚„ã™ã„ç‚¹ã‚’è¨˜è¼‰ -->

            ### æ”¹å–„ç‚¹
            <!-- å•é¡Œã‚„æ”¹å–„ã™ã¹ãç‚¹ã‚’è¨˜è¼‰ -->

            ### ãƒã‚°å ±å‘Š
            <!-- ç™ºè¦‹ã—ãŸãƒã‚°ã‚’è¨˜è¼‰ï¼ˆå†ç¾æ‰‹é †å«ã‚€ï¼‰ -->

            ### ææ¡ˆ
            <!-- æ–°æ©Ÿèƒ½ã®ææ¡ˆã‚„æ”¹å–„ã‚¢ã‚¤ãƒ‡ã‚¢ -->

            ## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            - åˆå›èª­ã¿è¾¼ã¿æ™‚é–“: ___ç§’
            - PWAåŒ–ã¾ã§ã®æ™‚é–“: ___ç§’
            - éŸ³å£°èªè­˜å¿œç­”æ™‚é–“: ___ç§’
            - ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚é–“: ___ç§’

            ## ğŸ“± ãƒ†ã‚¹ãƒˆç’°å¢ƒ
            - ãƒ‡ãƒã‚¤ã‚¹: 
            - OS: 
            - ãƒ–ãƒ©ã‚¦ã‚¶: 
            - ç”»é¢ã‚µã‚¤ã‚º:

            ## ğŸ¯ ç·åˆè©•ä¾¡
            - ä½¿ã„ã‚„ã™ã•: â­â­â­â­â­
            - æ©Ÿèƒ½æ€§: â­â­â­â­â­
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: â­â­â­â­â­
            - ãƒ‡ã‚¶ã‚¤ãƒ³: â­â­â­â­â­

            ---
            
            @team-vibe-coder ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼
            `,
              labels: ['feedback', 'staging', 'ux-testing']
            });

            console.log(`Created feedback issue: ${issue.html_url}`);